// 后端相关模块代码集合

$(function(){
    // 文本编辑器
    var testEditor=$("#test-editormd").length &&editormd("test-editormd", {
        path : '/bower_components/editor.md/lib/',
        theme : "dark",
        saveHTMLToTextarea:true,
        width: "100%",
        height: 540
    });

    $("#adt-btn").on("click",function(){
        //brief 用于文章列表显示的内容，单独为一段内容 ，从content分离出来
        var fg='<hr style="page-break-after:always;" class="page-break editormd-page-break">',c=testEditor.getPreviewedHTML(),f=c.indexOf(fg),b=c.split(fg);
        var params={
            name:$("[name='name']",".arform").val(),
            user:$("[name='user']",".arform").val(),
            cinfo:[$("#fl-category").find("option:selected").text(),$("#s-val").find("option:selected").text()].toString(),
            category:$("[name='category']",".arform").val(),
            brief:f>0?b[0]:"简介都没留下，文章到这份上真是够了<strong>文章编辑没有添加分页符，简介部分需要有分隔符分割才会显示.</strong>",
            content:f>0?b.join(""):c,
            draft:testEditor.getMarkdown()
        }
        $.post("/admin/article/add",params,function(data){
            window.location&&window.location.reload();
        });
    });
    $("#up-btn").on("click",function(){
        var fg='<hr style="page-break-after:always;" class="page-break editormd-page-break">',c=testEditor.getPreviewedHTML(),f=c.indexOf(fg),b=c.split(fg),
            upUrl=$(this).data("action");
        var params={
            name:$("[name='name']",".arform").val(),
            brief:f>0?b[0]:"简介都没留下，文章到这份上真是够了<strong>文章编辑没有添加分页符，简介部分需要有分隔符分割才会显示.</strong>",
            content:f>0?b.join(""):c,
            draft:testEditor.getMarkdown()
        }
        $.post(upUrl,params,function(data){
            if(data){
                window.location="/admin/article";
            }
        });
    });
    // 后台新建子类分类

    if($("[data-page='category']").length>0){
        $(".cr-btn").on("click",function(){
            var _that=$(this);
            $("#leaf1").val(_that.data("leaf"));
            $("#pid1").val(_that.data("pid"));
        });
        $(".crd-btn").on("click",function(){
            var _that=$(this);
            $("#leaf2").val(_that.data("leaf"));
            $("#pid2").val(_that.data("pid"));
            $("#confirm-delete").find("form").attr("action","/admin/category/delete/"+_that.data("oid")+"?_method=DELETE");
        });
        $('#myModal').on('hidden.bs.modal', function (e) {
            $("input[name='leaf']").val(0);
            $("#inputLable").val("");
        });
    }
    //新建文章 js
    if($("[data-page='newAA']").length>0){
        var d=$("#hcd").data("category");
        $("#fl-category").on("change",function(){
            var val=$(this).val();
            for(var i in d){
                if(d[i]._id==val){
                    var s=d[i].subCategory.map(function(v){
                        return "<option value='"+v._id+"'>" +v.name
                    }).join("");
                    $("#s-val").html(s);
                }
            }
        });
    }

    //文章列表 js
    if($("[data-page='article-list']").length>0){
        // 删除 文章
        $("#btn-del").on("click",function(){
            $.post($(this).data("action"),function(data){
                window.location&&window.location.reload();
            });
        });
    }
});